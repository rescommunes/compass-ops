{{- $pw := .Values.env.secrets.postgres.passwords.kratos -}}
kratos:
  automigration:
    enabled: true
    type: initContainer

  config:
    dsn: "postgresql://kratos:{{ $pw }}@postgres-cluster-rw.database.svc.cluster.local:5432/kratos"
    secrets:
      default: [ ]



    selfservice:
      default_browser_return_url: "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/"
      allowed_return_urls:
        - "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/"
        - "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}"
        - "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/login"

      flows:

        login:
          ui_url: "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/login/"
          lifespan: 1h

        registration:
          ui_url: "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/registration/"
          lifespan: 1h
          after:
            password:
              hooks:
                - hook: show_verification_ui
        settings:
          ui_url: "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/settings/"
          lifespan: 1h

        recovery:
          enabled: true
          use: code
          ui_url: "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/reset-password/"
          lifespan: 1h
          notify_unknown_recipients: false
          after:
            hooks:
              - hook: revoke_active_sessions

        verification:
          enabled: true
          use: code
          ui_url: "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/verification/"
          lifespan: 1h
          after:
            default_browser_return_url: "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/login"

        error:
          ui_url: "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}/error/"

      methods:
        password:
          enabled: true
          config:
            min_password_length: 8
            identifier_similarity_check_enabled: true
        link:
          enabled: false
        code:
          enabled: true
        oidc:
          enabled: true

    courier:
      smtp:
        from_address: "no-reply@{{ .Values.env.domain }}"
        connection_uri: {{ .Values.env.smtpConnectionUri | quote }}

    identity:
      default_schema_id: default
      schemas:
        - id: default
          url: base64://ewogICIkc2NoZW1hIjogImh0dHA6Ly9qc29uLXNjaGVtYS5vcmcvZHJhZnQtMDcvc2NoZW1hIyIsCiAgInR5cGUiOiAib2JqZWN0IiwKICAicHJvcGVydGllcyI6IHsKICAgICJ0cmFpdHMiOiB7CiAgICAgICJ0eXBlIjogIm9iamVjdCIsCiAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICJlbWFpbCI6IHsKICAgICAgICAgICJ0eXBlIjogInN0cmluZyIsCiAgICAgICAgICAiZm9ybWF0IjogImVtYWlsIiwKICAgICAgICAgICJ0aXRsZSI6ICJFLU1haWwiLAogICAgICAgICAgIm1pbkxlbmd0aCI6IDMsCiAgICAgICAgICAib3J5LnNoL2tyYXRvcyI6IHsKICAgICAgICAgICAgImNyZWRlbnRpYWxzIjogewogICAgICAgICAgICAgICJwYXNzd29yZCI6IHsKICAgICAgICAgICAgICAgICJpZGVudGlmaWVyIjogdHJ1ZQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgInZlcmlmaWNhdGlvbiI6IHsKICAgICAgICAgICAgICAidmlhIjogImVtYWlsIgogICAgICAgICAgICB9LAogICAgICAgICAgICAicmVjb3ZlcnkiOiB7CiAgICAgICAgICAgICAgInZpYSI6ICJlbWFpbCIKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgIm5hbWUiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgInRpdGxlIjogIk5hbWUiCiAgICAgICAgfSwKICAgICAgICAidXNlcm5hbWUiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgInRpdGxlIjogIlVzZXJuYW1lIgogICAgICAgIH0sCiAgICAgICAgInBpY3R1cmUiOiB7CiAgICAgICAgICAidHlwZSI6ICJzdHJpbmciLAogICAgICAgICAgInRpdGxlIjogIlByb2ZpbGUgUGljdHVyZSIKICAgICAgICB9CiAgICAgIH0sCiAgICAgICJyZXF1aXJlZCI6IFsiZW1haWwiXSwKICAgICAgImFkZGl0aW9uYWxQcm9wZXJ0aWVzIjogZmFsc2UKICAgIH0KICB9Cn0=

    session:
      cookie:
        same_site: None
        domain: ".{{ .Values.env.domain }}"
        path: "/"

    serve:
      public:
        base_url: "https://{{ .Values.env.subdomains.kratos }}.{{ .Values.env.domain }}"
        cors:
          enabled: true
          allowed_origins:
            - "https://{{ .Values.env.subdomains.account }}.{{ .Values.env.domain }}"
          allowed_methods: [ "GET","POST","PUT","PATCH","DELETE","OPTIONS" ]
          allowed_headers: [ "Authorization","Content-Type","X-Requested-With" ]
          exposed_headers: [ "Content-Type" ]
          allow_credentials: true
          max_age: 3600



  identitySchemas:
      "oidc.github.jsonnet": |
        local claims = std.extVar('claims');
        {
        identity: {
            traits: {
              email: claims.email,
            },
          },
        }
      "identity.schema.json": |
        {
          "$id": "https://schemas.ory.sh/presets/kratos/identity.email.schema.json",
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "Person",
          "type": "object",
          "properties": {
            "traits": {
              "type": "object",
              "properties": {
                "email": {
                  "type": "string",
                  "format": "email",
                  "title": "E-Mail",
                  "ory.sh/kratos": {
                    "credentials": {
                      "password": {
                        "identifier": true
                      }
                    },
                    "recovery": {
                      "via": "email"
                    },
                    "verification": {
                      "via": "email"
                    }
                  }
                }
              },
              "required": [
                "email"
              ],
              "additionalProperties": false
            }
          }
        }
    
    
